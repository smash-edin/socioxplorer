<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>solr_class &#8212; SocioXplorer Dashboard 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=4f649999" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=039e1c02" />
    <script src="../_static/documentation_options.js?v=8d563738"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for solr_class</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">configs</span> <span class="kn">import</span> <span class="n">ApplicationConfig</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<div class="viewcode-block" id="print_this">
<a class="viewcode-back" href="../solr_class.html#solr_class.print_this">[docs]</a>
<span class="k">def</span> <span class="nf">print_this</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An auxiliary function that prints a message within a square of (hash)s.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :message: (obj) The message to be printed, preferably a string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">len_message</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;## </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2"> ##&quot;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">*</span><span class="n">len_message</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s1"> ##</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;#&#39;</span><span class="o">*</span><span class="n">len_message</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_mapping_dict_to_count">
<a class="viewcode-back" href="../solr_class.html#solr_class.get_mapping_dict_to_count">[docs]</a>
<span class="k">def</span> <span class="nf">get_mapping_dict_to_count</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An auxiliary function that returns a dictionary that holds the passed name of the feature and the title count. \</span>
<span class="sd">    This is used in the report generation so we can map each feature to its own counts.</span>

<span class="sd">    Args:</span>
<span class="sd">        :name: (str) The name of the object that will be used as a key in the dictionary.</span>

<span class="sd">    Returns:</span>
<span class="sd">        :dict: A dictionary with keys (first and second) in which the first key holds the name of the feature and the \</span>
<span class="sd">            second holds the string &quot;count&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;first&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;second&#39;</span><span class="p">:</span> <span class="n">target</span><span class="p">}</span></div>




<div class="viewcode-block" id="sort_dict_with_names">
<a class="viewcode-back" href="../solr_class.html#solr_class.sort_dict_with_names">[docs]</a>
<span class="k">def</span> <span class="nf">sort_dict_with_names</span><span class="p">(</span><span class="n">my_dict</span><span class="p">,</span> <span class="n">top_n</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;To sort the dictionary based on the values and return the top n values.</span>

<span class="sd">    Args:</span>
<span class="sd">        :my_dict: (dict) A dictionary with keys and values to be sorted.</span>
<span class="sd">        :top_n: (int) The number of top values to be returned.</span>
<span class="sd">        :keys: (dict) A dictionary that holds information about my_dict contents.</span>

<span class="sd">    Returns:</span>
<span class="sd">        :dict: The sorted dictionary version from the input @my_dict by considering the top n values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">top_n</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">my_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
        <span class="n">top_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">my_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">sorted_dict</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">my_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">top_n</span><span class="p">):</span>
        <span class="c1">#result.append({keys[&#39;first&#39;]: sorted_dict[i][0][0].upper() + sorted_dict[i][0][1:].lower(),</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">keys</span><span class="p">[</span><span class="s1">&#39;first&#39;</span><span class="p">]:</span> <span class="n">sorted_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                       <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;second&#39;</span><span class="p">]:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">sorted_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])})</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="SolrClass">
<a class="viewcode-back" href="../solr_class.html#solr_class.SolrClass">[docs]</a>
<span class="k">class</span> <span class="nc">SolrClass</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Class containing the code that interfaces with the Solr cores in order to retrieve relevant data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">solrs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;*:*&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
        <span class="n">solr_cores</span> <span class="o">=</span> <span class="n">ApplicationConfig</span><span class="o">.</span><span class="n">SOLR_CORES</span>
        <span class="n">print_this</span><span class="p">(</span><span class="n">solr_cores</span><span class="p">)</span>
        <span class="n">solr_url</span> <span class="o">=</span> <span class="n">ApplicationConfig</span><span class="o">.</span><span class="n">SOLR_URL</span>
        <span class="n">solr_port</span> <span class="o">=</span> <span class="n">ApplicationConfig</span><span class="o">.</span><span class="n">SOLR_PORT</span>
        <span class="k">for</span> <span class="n">core</span> <span class="ow">in</span> <span class="n">solr_cores</span><span class="p">:</span> <span class="c1">#app.config[&#39;SOLR_CORES&#39;]:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">solr_url</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">solr_port</span><span class="si">}</span><span class="s2">/solr/</span><span class="si">{</span><span class="n">core</span><span class="si">}</span><span class="s2">/&quot;</span> <span class="c1">#app.config[&#39;SOLR_URL&#39;] #app.config[&#39;SOLR_PORT&#39;] #app.config[&#39;SOLR_CORES&#39;]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solrs</span><span class="p">[</span><span class="n">core</span><span class="p">]</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solr_query_builder</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
    
    
        
<div class="viewcode-block" id="SolrClass.create_facet">
<a class="viewcode-back" href="../solr_class.html#solr_class.SolrClass.create_facet">[docs]</a>
    <span class="k">def</span> <span class="nf">create_facet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; An auxiliary function that creates the facet json for the query.</span>

<span class="sd">        Args:</span>
<span class="sd">            :limit: (int) Maximum size of the retrieved data from Solr.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :dict: Dictionary with the required fields per facet to query the Solr core.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">facet_json_timelines</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Sentiments_Distributions&#39;</span><span class="p">:{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">limit</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;terms&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">:</span><span class="s1">&#39;sentiment&#39;</span><span class="p">,</span> <span class="s1">&#39;facet&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Sentiments_Distributions&#39;</span><span class="p">:{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">limit</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;terms&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">:</span><span class="s1">&#39;createdAtDays&#39;</span><span class="p">}}}}</span>
        <span class="n">facet_json_timelines</span><span class="p">[</span><span class="s1">&#39;traffic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">limit</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;terms&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">:</span><span class="s1">&#39;createdAtDays&#39;</span><span class="p">,</span> <span class="s1">&#39;facet&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;traffic&#39;</span><span class="p">:{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">limit</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;terms&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">:</span><span class="s1">&#39;createdAtDays&#39;</span><span class="p">}}}</span>
        <span class="n">facet_json_timelines</span><span class="p">[</span><span class="s1">&#39;Languages_Distributions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">limit</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;terms&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">:</span><span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;facet&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Languages_Distributions&#39;</span><span class="p">:{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">limit</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;terms&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">:</span><span class="s1">&#39;language&#39;</span><span class="p">}}}</span>
        <span class="n">facet_json_timelines</span><span class="p">[</span><span class="s1">&#39;tweets_locations_by_sentiments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">limit</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;terms&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">:</span><span class="s1">&#39;sentiment&#39;</span><span class="p">,</span> <span class="s1">&#39;facet&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;tweets_locations_by_sentiments&#39;</span><span class="p">:{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">limit</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;terms&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">:</span><span class="s1">&#39;locationGps&#39;</span><span class="p">}}}</span>
        <span class="n">facet_json_timelines</span><span class="p">[</span><span class="s1">&#39;tweets_languages_by_sentiments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">limit</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;terms&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">:</span><span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;facet&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;tweets_languages_by_sentiments&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">limit</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;terms&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">:</span><span class="s1">&#39;sentiment&#39;</span><span class="p">,</span> <span class="s1">&#39;facet&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;createdAtDays&#39;</span><span class="p">:{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">limit</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;terms&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">:</span><span class="s1">&#39;createdAtDays&#39;</span><span class="p">}}}}}</span>
        <span class="n">facet_json_timelines</span><span class="p">[</span><span class="s1">&#39;tweets_locations_by_languages&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">limit</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;terms&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">:</span><span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;facet&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;tweets_locations_by_languages&#39;</span><span class="p">:{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">limit</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;terms&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">:</span><span class="s1">&#39;locationGps&#39;</span><span class="p">}}}</span>
        <span class="n">facet_json_timelines</span><span class="p">[</span><span class="s1">&#39;users_locations_by_sentiments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">limit</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;terms&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">:</span><span class="s1">&#39;sentiment&#39;</span><span class="p">,</span> <span class="s1">&#39;facet&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;users_locations_by_sentiments&#39;</span><span class="p">:{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">limit</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;terms&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">:</span><span class="s1">&#39;userLocation&#39;</span><span class="p">}}}</span>
        <span class="n">facet_json_timelines</span><span class="p">[</span><span class="s1">&#39;users_locations_by_languages&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">limit</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;terms&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">:</span><span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;facet&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;users_locations_by_languages&#39;</span><span class="p">:{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">limit</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;terms&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">:</span><span class="s1">&#39;userLocation&#39;</span><span class="p">}}}</span>
        <span class="n">facet_json_timelines</span><span class="p">[</span><span class="s1">&#39;retweeted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">limit</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;terms&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">:</span><span class="s1">&#39;sentiment&#39;</span><span class="p">,</span> <span class="s1">&#39;facet&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;retweeted&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">limit</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;terms&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">:</span><span class="s1">&#39;userScreenName&#39;</span><span class="p">,</span> <span class="s1">&#39;facet&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;retweeted&#39;</span><span class="p">:{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">limit</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;func&#39;</span><span class="p">,</span><span class="s1">&#39;func&#39;</span><span class="p">:</span><span class="s2">&quot;&#39;countvals(retweeters)&#39;&quot;</span><span class="p">}}}}}</span>
        <span class="n">facet_json_timelines</span><span class="p">[</span><span class="s1">&#39;Sentiment_per_Language&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">limit</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;terms&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">:</span><span class="s1">&#39;sentiment&#39;</span><span class="p">,</span> <span class="s1">&#39;facet&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Sentiment_per_Language&#39;</span><span class="p">:{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">limit</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;terms&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">:</span><span class="s1">&#39;language&#39;</span><span class="p">}}}</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;urls&#39;</span><span class="p">,</span> <span class="s1">&#39;mentions&#39;</span><span class="p">,</span> <span class="s1">&#39;retweeters&#39;</span><span class="p">,</span> <span class="s1">&#39;hashtags&#39;</span><span class="p">,</span> <span class="s1">&#39;userScreenName&#39;</span><span class="p">,</span> <span class="s1">&#39;media&#39;</span><span class="p">,</span> <span class="s1">&#39;emojis&#39;</span><span class="p">,</span> <span class="s1">&#39;processedTokens&#39;</span><span class="p">,</span> <span class="s1">&#39;processedDescTokens&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
            <span class="n">facet_json_timelines</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">limit</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;terms&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">:</span><span class="s1">&#39;sentiment&#39;</span><span class="p">,</span> <span class="s1">&#39;facet&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">feature</span><span class="p">:{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">limit</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;terms&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">:</span><span class="n">feature</span><span class="p">}}}</span>
        <span class="k">return</span> <span class="n">facet_json_timelines</span></div>

    
<div class="viewcode-block" id="SolrClass.get_term_list_from_keywords">
<a class="viewcode-back" href="../solr_class.html#solr_class.SolrClass.get_term_list_from_keywords">[docs]</a>
    <span class="k">def</span> <span class="nf">get_term_list_from_keywords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keywords</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; A function that takes the keywords and returns a list of the keywords/phrases after removing the special \</span>
<span class="sd">        characters and replacing the spaces with the character %20.</span>

<span class="sd">        Args:</span>
<span class="sd">            :keywords: (str) The set of words that the user wants to query separated by comma (,). For the combined \</span>
<span class="sd">                words we expect the query to be separated with a space.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            :list: The list of unique tokens/phrases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[ </span><span class="se">\t\n</span><span class="s2">]+&quot;</span><span class="p">,</span> <span class="s1">&#39;%20&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[?!=.$@\/%]+&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">keywords</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]))</span></div>

    
<div class="viewcode-block" id="SolrClass.check_date_entry">
<a class="viewcode-back" href="../solr_class.html#solr_class.SolrClass.check_date_entry">[docs]</a>
    <span class="k">def</span> <span class="nf">check_date_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_text</span><span class="p">,</span> <span class="n">time_value</span><span class="o">=</span><span class="s2">&quot;T00:00:00Z&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; An auxiliary function that checks if the date is valid or not.</span>

<span class="sd">        Args:</span>
<span class="sd">            :date_text: (str) The date to be checked.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :bool: True if the date is valid, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date_text</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">time_value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>

        
<div class="viewcode-block" id="SolrClass.stringify_date_range">
<a class="viewcode-back" href="../solr_class.html#solr_class.SolrClass.stringify_date_range">[docs]</a>
    <span class="k">def</span> <span class="nf">stringify_date_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; An auxiliary function that handles the date range in the query. It creates the required string for the date \</span>
<span class="sd">        range in Solr query.</span>

<span class="sd">        Args:</span>
<span class="sd">            :filters: (dict) The filters that the user wants to apply on the query. The filter should include \</span>
<span class="sd">                date_start and date_end.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The string that is used in the query to filter the date range.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">date_range</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        
        <span class="k">if</span><span class="p">(</span><span class="s1">&#39;date_start&#39;</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">filters</span><span class="p">[</span><span class="s1">&#39;date_start&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span>  <span class="ow">and</span> <span class="n">filters</span><span class="p">[</span><span class="s1">&#39;date_start&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">date_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_date_entry</span><span class="p">(</span><span class="n">filters</span><span class="p">[</span><span class="s1">&#39;date_start&#39;</span><span class="p">],</span> <span class="n">time_value</span><span class="o">=</span><span class="s2">&quot;T00:00:00Z&quot;</span><span class="p">)</span>
            <span class="n">print_this</span><span class="p">(</span><span class="s2">&quot;filters[&#39;date_start&#39;]: |&quot;</span> <span class="o">+</span> <span class="n">date_start</span> <span class="o">+</span> <span class="s2">&quot;|&quot;</span><span class="p">)</span>
            <span class="n">date_range</span> <span class="o">=</span> <span class="s1">&#39;%20AND%20 createdAt:[&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">date_start</span> <span class="o">+</span> <span class="s1">&#39;%20TO%20&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">date_start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;*%20TO%20&#39;</span>
            <span class="n">print_this</span><span class="p">(</span><span class="s2">&quot;date_range: &quot;</span> <span class="o">+</span> <span class="n">date_range</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">filters</span><span class="p">[</span><span class="s1">&#39;date_start&#39;</span><span class="p">]</span>
        
        <span class="k">if</span><span class="p">(</span><span class="s1">&#39;date_end&#39;</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">filters</span><span class="p">[</span><span class="s1">&#39;date_end&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">filters</span><span class="p">[</span><span class="s1">&#39;date_end&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">date_range</span><span class="p">:</span>
                <span class="n">date_range</span> <span class="o">=</span> <span class="s1">&#39;%20AND%20 createdAt:[*%20TO%20&#39;</span>
            <span class="n">date_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_date_entry</span><span class="p">(</span><span class="n">filters</span><span class="p">[</span><span class="s1">&#39;date_end&#39;</span><span class="p">],</span> <span class="n">time_value</span><span class="o">=</span><span class="s2">&quot;T23:59:59Z&quot;</span><span class="p">)</span>
            <span class="n">print_this</span><span class="p">(</span><span class="s2">&quot;filters[&#39;date_end&#39;]: |&quot;</span> <span class="o">+</span> <span class="n">date_end</span> <span class="o">+</span> <span class="s2">&quot;|&quot;</span><span class="p">)</span>
            <span class="n">date_range</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">date_end</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">date_end</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;*]&#39;</span>
            <span class="k">del</span> <span class="n">filters</span><span class="p">[</span><span class="s1">&#39;date_end&#39;</span><span class="p">]</span>
            
        <span class="n">print_this</span><span class="p">(</span><span class="s2">&quot;date_range: &quot;</span> <span class="o">+</span> <span class="n">date_range</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="s2">&quot;* TO *&quot;</span> <span class="ow">in</span> <span class="n">date_range</span> <span class="ow">or</span> <span class="s1">&#39;*%20TO%20*&#39;</span>  <span class="ow">in</span> <span class="n">date_range</span><span class="p">:</span>
            <span class="n">date_range</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="n">date_range</span></div>

            
<div class="viewcode-block" id="SolrClass.stringify_filter_components">
<a class="viewcode-back" href="../solr_class.html#solr_class.SolrClass.stringify_filter_components">[docs]</a>
    <span class="k">def</span> <span class="nf">stringify_filter_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; An auxiliary function that handles the filters in the query. It creates the required string for the filters \</span>
<span class="sd">        in Solr query.</span>

<span class="sd">        Args:</span>
<span class="sd">            :filters: (dict) The filters that the user wants to apply on the query. The filter might hold data such as \</span>
<span class="sd">                date_start, date_end, language.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :tuple[str]: The date_range and the filters_part that are used in the query to filter the date range \</span>
<span class="sd">                and the other filters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">date_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stringify_date_range</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
        <span class="n">filters_part</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">!=</span> <span class="s1">&#39;date_start&#39;</span> <span class="ow">and</span> <span class="n">f</span><span class="o">!=</span> <span class="s1">&#39;date_end&#39;</span><span class="p">:</span>
                <span class="n">filter_terms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
                                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filter_terms</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">field_part</span> <span class="o">=</span> <span class="s1">&#39;%20AND%20(&#39;</span>
                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filter_terms</span><span class="p">):</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;language&#39;</span><span class="p">):</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">casefold</span><span class="p">()</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">filter_terms</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                            <span class="n">field_part</span> <span class="o">+=</span> <span class="n">f</span><span class="o">+</span><span class="s1">&#39;:*&#39;</span><span class="o">+</span><span class="n">t</span><span class="o">+</span><span class="s1">&#39;*%20&#39;</span><span class="o">+</span><span class="s1">&#39;OR&#39;</span><span class="o">+</span><span class="s1">&#39;%20&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">field_part</span> <span class="o">+=</span> <span class="n">f</span><span class="o">+</span><span class="s1">&#39;:*&#39;</span><span class="o">+</span><span class="n">t</span><span class="o">+</span><span class="s1">&#39;*%20&#39;</span>
                    <span class="n">field_part</span> <span class="o">+=</span> <span class="s1">&#39;)%20&#39;</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">field_part</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">filters_part</span> <span class="o">+=</span> <span class="n">field_part</span> 
        <span class="k">return</span> <span class="n">date_range</span><span class="p">,</span> <span class="n">filters_part</span></div>

                    
                    
<div class="viewcode-block" id="SolrClass.solr_query_builder">
<a class="viewcode-back" href="../solr_class.html#solr_class.SolrClass.solr_query_builder">[docs]</a>
    <span class="k">def</span> <span class="nf">solr_query_builder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{},</span> <span class="n">keywords</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="s1">&#39;AND&#39;</span><span class="p">,</span> <span class="n">limit</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A function that handles the query with relevant filters and keywords. It returns a dictionary of the \</span>
<span class="sd">        keywords and the corresponding JSON query.</span>

<span class="sd">        Args:</span>
<span class="sd">            :filters: (dict) Features required by the user to be considered in the query. Defaults to {} (optional).</span>
<span class="sd">            :keywords: (str, optional) Keywords (comma separated) that the user wants to query. Defaults to &#39;&#39; \</span>
<span class="sd">                which means include all keywords.</span>
<span class="sd">            :operator: (str, optional) The search operator (OR) and (AND) to be used among the keywords. Defaults \</span>
<span class="sd">                to &#39;AND&#39;.</span>
<span class="sd">            :limit: (int, optional) Maximum size (in count) of the retrieved data from Solr.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :query (str): The solr query to be used in the search.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># filters: location, date range, sentiment, language, products, company</span>
        <span class="n">term_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_term_list_from_keywords</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># stop condition to stop creating wrong query</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">term_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">query</span><span class="p">[</span><span class="s1">&#39;All&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;*:*&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s1">&#39;All&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;fullText:(%22&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;%22%20</span><span class="si">{</span><span class="n">operator</span><span class="si">}</span><span class="s1">%20%22&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">term_list</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;%22)&quot;</span>
            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">term_list</span><span class="p">:</span>
                <span class="n">query</span><span class="p">[</span><span class="n">term</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;fullText:%22</span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s2">%22&quot;</span>

        <span class="c1"># handle date ranges</span>
        <span class="n">date_range</span><span class="p">,</span> <span class="n">filters_part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stringify_filter_components</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">query</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">query</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="n">filters_part</span><span class="o">+</span><span class="n">date_range</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            
        <span class="n">facet_json_timelines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_facet</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">query_k</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">facet_json_query</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;query&#39;</span><span class="p">:</span> <span class="n">query</span><span class="p">[</span><span class="n">query_k</span><span class="p">],</span> <span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="mi">250</span> <span class="p">,</span> <span class="s1">&#39;facet&#39;</span><span class="p">:</span> <span class="n">facet_json_timelines</span><span class="p">}</span>
            <span class="n">query</span><span class="p">[</span><span class="n">query_k</span><span class="p">]</span> <span class="o">=</span> <span class="n">facet_json_query</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">query</span></div>



<div class="viewcode-block" id="SolrClass.normalize_sentiments">
<a class="viewcode-back" href="../solr_class.html#solr_class.SolrClass.normalize_sentiments">[docs]</a>
    <span class="k">def</span> <span class="nf">normalize_sentiments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sub_value</span><span class="p">,</span> <span class="n">total_value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A function that normalizes the sentiments to be between -1 and 1. \</span>
<span class="sd">        The normalisation is done based on the equation:  \</span>
<span class="sd">        ( -1 * COUNT(NEG) + 0 * COUNT(NEUT) + 1 * COUNT(POS)) / (COUNT(NEG) + COUNT(NEUT) + COUNT(POS))\</span>
<span class="sd">        However, to invest the already computed values, the equation is simplified to: sub_value / total_value ... in \</span>
<span class="sd">        which, the sub_value is the sum of the positive and negative sentiments and the total_value is the sum of all \</span>
<span class="sd">        sentiments.</span>

<span class="sd">        Args:</span>
<span class="sd">            :sub_value: (int) Total counts for both the positive and negative sentiments.</span>
<span class="sd">            :total_value: (int) Total counts for all sentiments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :long: Normalized value in range [-1;1] inclusive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">sub_value</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">total_value</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="SolrClass.get_maximum">
<a class="viewcode-back" href="../solr_class.html#solr_class.SolrClass.get_maximum">[docs]</a>
    <span class="k">def</span> <span class="nf">get_maximum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report_obj</span><span class="p">,</span> <span class="n">item_field</span><span class="p">,</span> <span class="n">sentiment</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; An auxiliary function that gets the maximum value of the retweet count for the top field type (which would \</span>
<span class="sd">        be users or tweets).</span>

<span class="sd">        Args:</span>
<span class="sd">            :report_obj: (dict) Dictionary containing the reported tweets and users.</span>
<span class="sd">            :item_field: (str) Field&#39;s type (&quot;users&quot; or &quot;tweets&quot;).</span>
<span class="sd">            :sentiment: (str) Sentiment (positive, negative, or neutral).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">item_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">report_obj</span><span class="p">[</span><span class="s1">&#39;All Sentiments&#39;</span><span class="p">]:</span>
            <span class="n">report_obj</span><span class="p">[</span><span class="s1">&#39;All Sentiments&#39;</span><span class="p">][</span><span class="n">item_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">report_obj</span><span class="p">[</span><span class="n">sentiment</span><span class="p">][</span><span class="n">item_field</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">report_obj</span><span class="p">[</span><span class="s1">&#39;All Sentiments&#39;</span><span class="p">][</span><span class="n">item_field</span><span class="p">][</span><span class="s1">&#39;retweetCount&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">report_obj</span><span class="p">[</span><span class="n">sentiment</span><span class="p">][</span><span class="n">item_field</span><span class="p">][</span><span class="s1">&#39;retweetCount&#39;</span><span class="p">]:</span>
            <span class="n">report_obj</span><span class="p">[</span><span class="s1">&#39;All Sentiments&#39;</span><span class="p">][</span><span class="n">item_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">report_obj</span><span class="p">[</span><span class="n">sentiment</span><span class="p">][</span><span class="n">item_field</span><span class="p">]</span></div>

        
<div class="viewcode-block" id="SolrClass.combine_all_sentiments">
<a class="viewcode-back" href="../solr_class.html#solr_class.SolrClass.combine_all_sentiments">[docs]</a>
    <span class="k">def</span> <span class="nf">combine_all_sentiments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report_groups</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;An auxiliary function that combines all sentiments into one group. It is used to compute the top users and \</span>
<span class="sd">        top tweets for all sentiments.</span>

<span class="sd">        Args:</span>
<span class="sd">            :report_groups: (dict) Dictionary of the sentiments and the corresponding users and tweets.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :tuple[dict]: Reports of the top users and top tweets for all sentiments combined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">report_groups_users</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;All Sentiments&#39;</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="n">report_groups_tweets</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;All Sentiments&#39;</span><span class="p">:</span> <span class="p">{}}</span>
        
        <span class="k">for</span> <span class="n">sentiment</span> <span class="ow">in</span>  <span class="n">report_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sentiment</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">report_groups_users</span><span class="p">:</span>
                <span class="n">report_groups_users</span><span class="p">[</span><span class="n">sentiment</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">sentiment</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">report_groups_tweets</span><span class="p">:</span>
                <span class="n">report_groups_tweets</span><span class="p">[</span><span class="n">sentiment</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">report_groups</span><span class="p">[</span><span class="n">sentiment</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s1">&#39;userScreenName&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">report_groups</span><span class="p">[</span><span class="n">sentiment</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    
                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;userScreenName&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">report_groups_users</span><span class="p">[</span><span class="n">sentiment</span><span class="p">]:</span>
                    <span class="n">report_groups_users</span><span class="p">[</span><span class="n">sentiment</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;userScreenName&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;userScreenName&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;userScreenName&#39;</span><span class="p">],</span> <span class="s1">&#39;user_description&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;usersDescription&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;usersDescription&#39;</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s1">&#39;retweetCount&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;retweetCount&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;retweetCount&#39;</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;language&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;language&#39;</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;userLocation&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;userLocation&#39;</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_maximum</span><span class="p">(</span><span class="n">report_groups_users</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;userScreenName&#39;</span><span class="p">],</span> <span class="n">sentiment</span><span class="p">)</span>
                    
                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">report_groups_tweets</span><span class="p">[</span><span class="n">sentiment</span><span class="p">]:</span>
                    <span class="n">report_groups_tweets</span><span class="p">[</span><span class="n">sentiment</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">=</span>  <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="p">,</span> <span class="s1">&#39;fullText&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;fullText&#39;</span><span class="p">],</span> <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;createdAtDays&#39;</span><span class="p">],</span> <span class="s1">&#39;retweetCount&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;retweetCount&#39;</span><span class="p">],</span> <span class="s1">&#39;language&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;language&#39;</span><span class="p">],</span> <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="s1">&#39;locationGps&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">else</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;locationGps&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;locationGps&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;not_available&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>  <span class="p">}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_maximum</span><span class="p">(</span><span class="n">report_groups_tweets</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">sentiment</span><span class="p">)</span>
                    
            <span class="n">report_groups_tweets</span><span class="p">[</span><span class="n">sentiment</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">report_groups_tweets</span><span class="p">[</span><span class="n">sentiment</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">report_groups_users</span><span class="p">[</span><span class="n">sentiment</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">report_groups_users</span><span class="p">[</span><span class="n">sentiment</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">report_groups_tweets</span><span class="p">[</span><span class="s1">&#39;All Sentiments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">report_groups_tweets</span><span class="p">[</span><span class="s1">&#39;All Sentiments&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">report_groups_users</span><span class="p">[</span><span class="s1">&#39;All Sentiments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">report_groups_users</span><span class="p">[</span><span class="s1">&#39;All Sentiments&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">report_groups_users</span><span class="p">,</span> <span class="n">report_groups_tweets</span></div>

    
<div class="viewcode-block" id="SolrClass.compute_positive_negative">
<a class="viewcode-back" href="../solr_class.html#solr_class.SolrClass.compute_positive_negative">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_positive_negative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report_object</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">top_n</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; A function that computes the positive and negative sentiments for a given feature. It then sorts the \</span>
<span class="sd">        resulted dicts with their mapped names based on the top_n by calling the function sort_dict_with_names.</span>

<span class="sd">        Args:</span>
<span class="sd">            :report_object: (dict[dict]) Part of the report object that holds the sentiments for each feature.</span>
<span class="sd">            :feature: (str) Feature name, used to determine the type of the feature and the corresponding \</span>
<span class="sd">                computation for the Negative_Positive component.</span>
<span class="sd">            :top_n: (int) Length of the returned list of each sorted items.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;All Sentiments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;Positive_Negative&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sentiment</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">report_object</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">report_object</span><span class="p">[</span><span class="n">s</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">my_dict</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="p">(</span><span class="n">report_object</span><span class="p">[</span><span class="n">sentiment</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">],</span> <span class="n">report_object</span><span class="p">[</span><span class="n">sentiment</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">])</span> <span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">report_object</span><span class="p">[</span><span class="n">sentiment</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">my_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">my_dict</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">my_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;All Sentiments&#39;</span><span class="p">]:</span>
                        <span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;All Sentiments&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;All Sentiments&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">my_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">sentiment</span> <span class="o">==</span> <span class="s2">&quot;Positive&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;Positive_Negative&#39;</span><span class="p">]:</span>
                            <span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;Positive_Negative&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;Positive_Negative&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">my_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">sentiment</span> <span class="o">==</span> <span class="s2">&quot;Negative&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;Positive_Negative&#39;</span><span class="p">]:</span>
                            <span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;Positive_Negative&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">my_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;Positive_Negative&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">-=</span> <span class="n">my_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;Positive_Negative&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;All Sentiments&#39;</span><span class="p">]:</span>
                <span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;Positive_Negative&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_sentiments</span><span class="p">(</span><span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;Positive_Negative&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">],</span> <span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;All Sentiments&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;Positive_Negative&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;All Sentiments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sort_dict_with_names</span><span class="p">(</span><span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;All Sentiments&#39;</span><span class="p">],</span> <span class="n">top_n</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">get_mapping_dict_to_count</span><span class="p">(</span><span class="s1">&#39;val&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">feature</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;users_locations_by_sentiments&#39;</span><span class="p">,</span> <span class="s1">&#39;tweets_locations_by_sentiments&#39;</span><span class="p">,</span> <span class="s1">&#39;users_languages_by_sentiments&#39;</span><span class="p">,</span> <span class="s1">&#39;tweets_languages_by_sentiments&#39;</span><span class="p">]:</span>
            <span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;Negative_Positive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sort_dict_with_names</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;Positive_Negative&#39;</span><span class="p">]),</span> <span class="n">top_n</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">get_mapping_dict_to_count</span><span class="p">(</span><span class="s1">&#39;val&#39;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;Positive_Negative&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sort_dict_with_names</span><span class="p">(</span><span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;Positive_Negative&#39;</span><span class="p">],</span> <span class="n">top_n</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">get_mapping_dict_to_count</span><span class="p">(</span><span class="s1">&#39;val&#39;</span><span class="p">))</span></div>



<div class="viewcode-block" id="SolrClass.get_all_languages">
<a class="viewcode-back" href="../solr_class.html#solr_class.SolrClass.get_all_languages">[docs]</a>
    <span class="k">def</span> <span class="nf">get_all_languages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report_object</span><span class="p">,</span> <span class="n">top_n</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; A function that computes the languages for all sentiments. It then sorts the resulted dicts with their mapped names based on the top_n by calling the function sort_dict_with_names.</span>

<span class="sd">        Args:</span>
<span class="sd">            :report_object: (dict[dict]) Part of the report that holds the languages for each sentiment.</span>
<span class="sd">            :top_n: (int) Length of the returned list of each sorted items.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;All Languages&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sentiment</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">report_object</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">my_dict</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="p">(</span><span class="n">report_object</span><span class="p">[</span><span class="n">sentiment</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">],</span> <span class="n">report_object</span><span class="p">[</span><span class="n">sentiment</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">])</span> <span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">report_object</span><span class="p">[</span><span class="n">sentiment</span><span class="p">])))</span>
                <span class="n">my_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">my_dict</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">my_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;All Languages&#39;</span><span class="p">]:</span>
                        <span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;All Languages&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;All Languages&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">my_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;All Languages&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sort_dict_with_names</span><span class="p">(</span><span class="n">report_object</span><span class="p">[</span><span class="s1">&#39;All Languages&#39;</span><span class="p">],</span> <span class="n">top_n</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">get_mapping_dict_to_count</span><span class="p">(</span><span class="s1">&#39;val&#39;</span><span class="p">))</span></div>

        
        
<div class="viewcode-block" id="SolrClass.optimised_json_query_handler">
<a class="viewcode-back" href="../solr_class.html#solr_class.SolrClass.optimised_json_query_handler">[docs]</a>
    <span class="k">def</span> <span class="nf">optimised_json_query_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solr_core</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">250</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; It is the optimised function that is based on JSON query requests. It needs the query, solr object and top_n</span>
<span class="sd">        as input. It also uses the query previsously built by calling @solr_query_builder. This query is a dictionary</span>
<span class="sd">        of the keywords and the corresponding JSON query.</span>

<span class="sd">        Args:</span>
<span class="sd">            :solr_core: (str) Name of the Solr core to query from.</span>
<span class="sd">            :top_n: (int, optional) Maximum number of results to return for the top content fields. Defaults to 250.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :tuple: Contains a dictionary with the report that corresponds to the query, and the total number of \</span>
<span class="sd">                tweets found for the query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">report</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">print_this</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solrs</span><span class="p">[</span><span class="n">solr_core</span><span class="p">])</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">query_term</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">:</span>
            
            <span class="n">facet_url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solrs</span><span class="p">[</span><span class="n">solr_core</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;select?fl=id%2C</span><span class="si">%20f</span><span class="s2">ull_text%2C</span><span class="si">%20c</span><span class="s2">reated_at_days%2C</span><span class="si">%20u</span><span class="s2">ser_screen_name%2C</span><span class="si">%20u</span><span class="s2">sers_description%2C</span><span class="si">%20lo</span><span class="s2">cation_gps%2C</span><span class="si">%20u</span><span class="s2">ser_location%2C</span><span class="si">%20e</span><span class="s2">mbedding_5d%2C%20processedTokens%2C</span><span class="si">%20r</span><span class="s2">etweet_count%2Clanguage%2Ctopics&amp;group.field=sentiment&amp;group.limit=10000&amp;group.sort=retweetCount</span><span class="si">%20d</span><span class="s2">esc%2CuserLocation</span><span class="si">%20a</span><span class="s2">sc%2ClocationGps</span><span class="si">%20a</span><span class="s2">sc&amp;group=true&amp;indent=true&amp;q.op=OR&amp;q=*%3A*&amp;rows=0&amp;sort=retweetCount</span><span class="si">%20d</span><span class="s2">esc&quot;</span>
            <span class="c1">#facet_url = str(self.solrs[solr_core]) + &quot;select?fl=id%2CfullText%2CcreatedAtDays%2CuserScreenName%2CusersDescription%2ClocationGps%2CuserLocation%2Cembedding_5d%2CprocessedTokens%2CretweetCount%2Clanguage%2Ctopics&amp;indent=true&amp;q.op=OR&amp;q=*%3A*&amp;rows=5&amp;sort=retweetCount%20desc&quot;</span>
            <span class="n">facet_url</span> <span class="o">=</span> <span class="n">facet_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s2">&quot;%20&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;&amp;json=&quot;</span><span class="o">+</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">[</span><span class="n">query_term</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">query_term</span> <span class="o">=</span> <span class="n">query_term</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%22&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%20&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">print_this</span><span class="p">(</span><span class="n">query_term</span><span class="p">)</span>
            <span class="n">print_this</span><span class="p">(</span><span class="n">facet_url</span><span class="p">)</span>
            <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">facet_url</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="n">report_groups</span> <span class="o">=</span> <span class="p">{</span><span class="n">items</span><span class="p">[</span><span class="s1">&#39;groupValue&#39;</span><span class="p">]:</span> <span class="n">items</span><span class="p">[</span><span class="s1">&#39;doclist&#39;</span><span class="p">][</span><span class="s1">&#39;docs&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="s1">&#39;grouped&#39;</span><span class="p">][</span><span class="s1">&#39;sentiment&#39;</span><span class="p">][</span><span class="s1">&#39;groups&#39;</span><span class="p">]}</span>
            <span class="n">report_groups_users</span><span class="p">,</span> <span class="n">report_groups_tweets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_all_sentiments</span><span class="p">(</span><span class="n">report_groups</span><span class="p">)</span> 
            
            <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">]</span> <span class="o">=</span> <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="s1">&#39;facets&#39;</span><span class="p">]</span>
              
            <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">])</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;buckets&#39;</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span>  <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">][</span><span class="s1">&#39;buckets&#39;</span><span class="p">]</span>
                        
                    <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">object_</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]:</span> <span class="n">object_</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="s1">&#39;buckets&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">object_</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">]}</span>    
                    <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;tweets_languages_by_sentiments&#39;</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">language</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">][</span><span class="n">language</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                                <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">][</span><span class="n">language</span><span class="p">]</span> <span class="o">=</span>  <span class="p">{</span><span class="n">object_</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]:</span> <span class="n">object_</span><span class="p">[</span><span class="s1">&#39;createdAtDays&#39;</span><span class="p">][</span><span class="s1">&#39;buckets&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">object_</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">][</span><span class="n">language</span><span class="p">]}</span> 
                                   
                    <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;users_locations_by_sentiments&#39;</span><span class="p">,</span> <span class="s1">&#39;tweets_locations_by_sentiments&#39;</span><span class="p">,</span> <span class="s1">&#39;userScreenName&#39;</span><span class="p">,</span> <span class="s1">&#39;urls&#39;</span><span class="p">,</span> <span class="s1">&#39;retweeters&#39;</span><span class="p">,</span> <span class="s1">&#39;retweeted&#39;</span><span class="p">,</span> <span class="s1">&#39;processedTokens&#39;</span><span class="p">,</span> <span class="s1">&#39;processedDescTokens&#39;</span><span class="p">,</span> <span class="s1">&#39;mentions&#39;</span><span class="p">,</span> <span class="s1">&#39;hashtags&#39;</span><span class="p">,</span> <span class="s1">&#39;media&#39;</span><span class="p">,</span> <span class="s1">&#39;emojis&#39;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">compute_positive_negative</span><span class="p">(</span><span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">],</span> <span class="n">feature</span><span class="p">,</span> <span class="n">top_n</span><span class="p">)</span>
                            
                    <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;tweets_locations_by_languages&#39;</span><span class="p">,</span> <span class="s1">&#39;users_locations_by_languages&#39;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">get_all_languages</span><span class="p">(</span><span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">],</span> <span class="n">top_n</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hashtags&#39;</span><span class="p">,</span> <span class="s1">&#39;processedDescTokens&#39;</span><span class="p">,</span> <span class="s1">&#39;processedTokens&#39;</span><span class="p">,</span> <span class="s1">&#39;emojis&#39;</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">sentiment</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">][</span><span class="n">sentiment</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]}</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">][</span><span class="n">sentiment</span><span class="p">]]</span>
                    
                    <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;traffic&#39;</span><span class="p">]:</span>
                        <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">({</span><span class="s1">&#39;Date&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">],</span> <span class="s1">&#39;Count&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">]}</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                        <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Languages_Distributions&#39;</span><span class="p">]:</span>
                        <span class="c1">#pass</span>
                        <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">({</span><span class="s1">&#39;Language&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="s1">&#39;Count&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">]}</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span>
                        <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Count&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
                <span class="c1">#terminate at top 150 items...</span>
                <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hashtags&#39;</span><span class="p">,</span> <span class="s1">&#39;emojis&#39;</span><span class="p">,</span> <span class="s1">&#39;media&#39;</span><span class="p">,</span> <span class="s1">&#39;mentions&#39;</span><span class="p">,</span> <span class="s1">&#39;urls&#39;</span><span class="p">,</span> <span class="s1">&#39;processedTokens&#39;</span><span class="p">,</span> <span class="s1">&#39;processedDescTokens&#39;</span><span class="p">,</span> <span class="s1">&#39;userScreenName&#39;</span><span class="p">,</span> <span class="s1">&#39;retweeters&#39;</span><span class="p">,</span> <span class="s1">&#39;retweeted&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">sentiment</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">][</span><span class="n">sentiment</span><span class="p">]</span> <span class="o">=</span> <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="n">feature</span><span class="p">][</span><span class="n">sentiment</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">149</span><span class="p">]</span>
            <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="s1">&#39;top_tweets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">report_groups_tweets</span>
            <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="s1">&#39;top_users&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">report_groups_users</span>
            
            <span class="n">hits</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">hits</span><span class="p">,</span> <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">])</span>
        
        <span class="k">for</span> <span class="n">query_term</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">report</span><span class="p">[</span><span class="n">query_term</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">report</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">query_term</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">report</span><span class="p">,</span> <span class="n">hits</span></div>

    
    
<div class="viewcode-block" id="SolrClass.optimised_json_query_handler_topics">
<a class="viewcode-back" href="../solr_class.html#solr_class.SolrClass.optimised_json_query_handler_topics">[docs]</a>
    <span class="k">def</span> <span class="nf">optimised_json_query_handler_topics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solr_core</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">date_start</span><span class="p">,</span> <span class="n">date_end</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; It is the optimised function that is based on JSON query requests for Topics. It nees the query, solr \</span>
<span class="sd">        object and rows to be returned. The query is a dictionary of the keywords and the corresponding JSON \</span>
<span class="sd">        query, and in our system is built be @solr_query_builder.</span>

<span class="sd">        Args:</span>
<span class="sd">            :solr_core: (str) Name of the Solr core to query from.</span>
<span class="sd">            :keyword: (str) Comma-separated list of keywords to query.</span>
<span class="sd">            :date_start: (str) Start of the date range in YYYY-MM-DD format. Must be &quot;&quot; if no start date is specified.</span>
<span class="sd">            :date_end: (str) End of the date range in YYYY-MM-DD format. Must be &quot;&quot; if no end date is specified.</span>
<span class="sd">            :rows: (int, optional) Maximum number of datapoints to be returned for the topics query. Defaults to 5000.</span>
<span class="sd">            :random_seed: (int, optional) Random seed to control the random selection of data when number of results \</span>
<span class="sd">                exceeds the maximum number of rows. Defaults to 42.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :tuple: Contains a dictionary with the report that corresponds to the query, and the total number of \</span>
<span class="sd">                tweets found for the query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># getting a random number from 0 to 10000, the seed is loaded form the interface.</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="n">random_number</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">9999</span><span class="p">)</span>
        
        <span class="n">report</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        if date_start != &quot;&quot; and date_end != &quot;&quot;:</span>
<span class="sd">            date_range = f&quot;[{date_start} TO {date_end}]&quot;</span>
<span class="sd">        else:</span>
<span class="sd">            date_range = &quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">date_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stringify_date_range</span><span class="p">({</span><span class="s2">&quot;date_start&quot;</span><span class="p">:</span><span class="n">date_start</span><span class="p">,</span> <span class="s2">&quot;date_end&quot;</span><span class="p">:</span><span class="n">date_end</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keyword</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>
        <span class="k">elif</span> <span class="n">keyword</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">keyword</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>
        
        <span class="n">hits</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Enalbe the following line to use the sentiments with Topics.</span>
        <span class="c1">#facet_url = str(self.solrs[solr_core]) + &quot;select?fl=id%2C%20fullText%2C%20embedding_5d&amp;group.field=sentiment&amp;group.limit=&quot; + str(rows) + &quot;&amp;group=true&amp;indent=true&amp;q.op=OR&amp;q=fullText%3A&quot; + str(keyword.replace(&quot; &quot;, &quot;%20&quot;)) + date_range.replace(&quot; &quot;,&quot;%20&quot;).replace(&quot;\&quot;&quot;,&quot;&quot;).replace(&quot;&#39;&quot;,&quot;&quot;)</span>
        <span class="n">facet_url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solrs</span><span class="p">[</span><span class="n">solr_core</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;select?sort=&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;random_</span><span class="si">{</span><span class="n">random_number</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">%20a</span><span class="s2">sc&amp;fl=id%2C</span><span class="si">%20f</span><span class="s2">ull_text%2C</span><span class="si">%20e</span><span class="s2">mbedding_5d%2C</span><span class="si">%20e</span><span class="s2">mbedding_2d%2C</span><span class="si">%20s</span><span class="s2">entiment&amp;rows=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mf">1.2</span><span class="o">*</span><span class="n">rows</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;&amp;indent=true&amp;q.op=OR&amp;q=fullText%3A&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">keyword</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;%20&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="n">date_range</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s2">&quot;%20&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=========&quot;</span><span class="p">)</span>
        <span class="n">print_this</span><span class="p">(</span><span class="n">facet_url</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">facet_url</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
            <span class="n">keyword</span> <span class="o">=</span> <span class="s2">&quot;All&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;time taken: &quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------&quot;</span><span class="p">)</span>
        <span class="n">print_this</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">][</span><span class="s1">&#39;docs&#39;</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=========&quot;</span><span class="p">)</span>
        
        <span class="n">hits</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">][</span><span class="s1">&#39;numFound&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------&quot;</span><span class="p">)</span>
        <span class="n">print_this</span><span class="p">(</span><span class="s2">&quot;hits: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">hits</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=========&quot;</span><span class="p">)</span>
        
        <span class="n">report</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">][</span><span class="s1">&#39;docs&#39;</span><span class="p">])</span>
            
        <span class="c1">#Replace the top with the following lines to use the sentiments with Topics.</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        print(&quot;---------&quot;)</span>
<span class="sd">        print_this(len(response[&#39;grouped&#39;][&#39;sentiment&#39;][&#39;groups&#39;]))</span>
<span class="sd">        print(&quot;=========&quot;)</span>
<span class="sd">        </span>
<span class="sd">        for group in response[&#39;grouped&#39;][&#39;sentiment&#39;][&#39;groups&#39;]:</span>
<span class="sd">            report[group[&#39;groupValue&#39;]] = list(group[&#39;doclist&#39;][&#39;docs&#39;])</span>
<span class="sd">        hits = response[&#39;grouped&#39;][&#39;sentiment&#39;][&#39;matches&#39;]</span>
<span class="sd">                </span>
<span class="sd">        for sentiments in list(report.keys()):</span>
<span class="sd">            if &quot;All Sentiments&quot; not in report:</span>
<span class="sd">                report[&quot;All Sentiments&quot;] = list()</span>
<span class="sd">            report[&quot;All Sentiments&quot;] += report[sentiments]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">report</span><span class="p">,</span> <span class="n">hits</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">SocioXplorer Dashboard</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">api</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, Sandrine Chausson, Youssef Al Hariri, Bjorn Ross.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>